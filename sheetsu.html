<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>fromSheetsToJekyll</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <link rel="stylesheet" href="ripple.css">
    <style>
        .pageload-overlay {
            position: fixed;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            visibility: hidden;
            background: rgba(0,0,0,.7);
        }

        .pageload-overlay.show {
            visibility: visible;
        }

        .pageload-overlay .spin-container {
            margin: auto;
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
        }
    </style>
</head>
<body>
<div class="jumbotron">
    <div class="container">
        <h1>From Sheets to Jekyll</h1>
        <p>Turn your Google Sheets into Jekyll files - Sheetsu Flavored</p>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="col-xs-12">
            <h2>Step 1: <small>Learn about the awesomeness of <a href="http://sheetsu.com/" target="_blank" alt="sheetsu.com">Sheetsu.com</a></small></h2>
            <p>Create an API, paste the URL below</p>
            <div class="form-group">
                <label for="getUrl" class="control-label">Sheetsu API URL</label>
                <input type="text" value="http://sheetsu.com/apis/fe179874" id="getUrl" class="form-control">
                <span class="glyphicon glyphicon-ok form-control-feedback hidden" aria-hidden="true" id="getUrlFeedback"></span>
                <span id="getUrlStatus" class="sr-only">gtg!</span>
            </div><!-- /input-group -->
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <h2>Step 2: <small>Check that your API works</small></h2>
            <div id="getUrlAlert" class="hidden alert alert-success">
                <h3>You're gtg, dude or dudette! <span class="glyphicon glyphicon-thumbs-up"></span></h3>
            </div>
            <button class="btn btn-default" type="button" id="checkUrl">Check</button>
        </div>
    </div>
</div>
<div class="container hidden" id="apiOk">
    <div class="row">
        <div class="col-xs-12">
            <h2>Step 3: <small>Choose what type of file you want to make</small></h2>
            <table class="table">
                <thead>
                <tr><th>Type</th><th>Description</th></tr>
                </thead>
                <tbody>
                <tr><td>Data File</td><td>Formatted as a jekyll data file that you can drop into your _data/ folder. Choose your key!</td></tr>
                <tr><td>Template</td><td>Create a template and propogate front matter. I hope, soon.</td></tr>
                <tr><td>Json</td><td>A simple json printout of your sheet. Pretty boring stuff...</td></tr>
                </tbody>
            </table>
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" role="tablist">
                <li role="presentation" class="active"><a href="#dataFile" aria-controls="dataFile" role="tab" data-toggle="tab">Jekyll Data File</a></li>
                <li role="presentation"><a href="#templates" aria-controls="templates" role="tab" data-toggle="tab">Templates</a></li>
                <li role="presentation"><a href="#simpleJson" aria-controls="simpleJson" role="tab" data-toggle="tab">Json</a></li>
            </ul>

            <!-- Tab panes -->
            <div class="tab-content">
                <div role="tabpanel" class="tab-pane active" id="dataFile">
                    <h3>Make a Jekyll data file</h3>
                    <h4>Select A Key</h4>
                    <div id="dataFileKey"></div>
                </div>
                <div role="tabpanel" class="tab-pane" id="templates">
                    <h3>Create html files for the _post directory</h3>
                    <!-- Button trigger modal -->
                    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#frontMatterModal">
                        Normalized Sheets Keys
                    </button>
                    <div class="form-group">
                        <label for="addFrontMatter">Add front matter</label>
                        <textarea id="addFrontMatter" class="form-control"></textarea>
                        <span class="help-block">
                            <strong>DO NOT INCLUDE THE <code>title:</code> front matter. This script will use the value from File Title below</strong><br>
                            To include sheets data as front matter, provide a name, colon, then the normalized sheets key wrapped in brackets. eg. <code>location: [Presentation-Location]</code>
                            <br>Additionally, you can make a list of associated values using hyphen+space. e.g.
                            <br>
                            <br>If the content is sensitive but you want to use it as a key to other content (e.g. email) you can add <code>|hash</code> to the end of the key.
                            <br>You can slugify the key by adding <code>|slug</code> to the end of the key.
                            <br>
                            <code>
                                speakers:<br>
                                - [Speaker-1]<br>
                                - [Speaker-2]
                            </code>
                            <br>If the data is linked to a yaml data file, be sure to use the key of that entry (e.g. a speaker's email instead of the speaker's name)
                        </span>
                    </div>
                    <div class="form-group">
                        <label for="fileTitle">Title: Select the input you want to use as the file's title</label>
                        <select name="fileTitle" id="fileTitle" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label for="jekyllContent">Content: Select the input you want to use as the content</label>
                        <select name="jekyllContent" id="jekyllContent" class="form-control"></select>
                    </div>
                    <div class="form-group">
                        <label for="fileDate">Date: Enter a date to prepend to the file titles</label>
                        <input type="text" class="form-control" id="fileDate" name="fileDate" value="2016-03-07">
                        <span class="help-block">yyyy-mm-dd</span>
                    </div>
                    <!-- Modal -->
                    <div class="modal fade" id="frontMatterModal" tabindex="-1" role="dialog" aria-labelledby="frontMatterModalLabel">
                        <div class="modal-dialog" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                                    <h4 class="modal-title" id="frontMatterModalLabel">Possible Front Matter Values</h4>
                                </div>
                                <div class="modal-body" id="frontMatterKeys">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div role="tabpanel" class="tab-pane" id="simpleJson"><h3>No options here</h3></div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xs-12">
            <h2>Step 4: <small>Boomshakalaka!</small></h2>
            <button class="btn btn-default" id="boom">Boomshakalaka!</button>
        </div>
    </div>
    <div class="row hidden" id="step5">
        <div class="col-xs-12">
            <h2>Step 5: <small>DATA!</small></h2>
            <!-- Trigger -->
            <button class="cp-btn btn" data-clipboard-target="#response">
                Copy to clipboard
            </button>
            <pre id="response"></pre>
        </div>
    </div>
</div>
</body>
<div id="loader" class="pageload-overlay">
    <div class="spin-container">
        <div class="spinner">
            <div class="rect1"></div>
            <div class="rect2"></div>
            <div class="rect3"></div>
            <div class="rect4"></div>
            <div class="rect5"></div>
        </div>
    </div>
</div><!-- /pageload-overlay -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="scripts/tabletop.js"></script>
<script src="scripts/jszip.js"></script>
<script src="scripts/clipboard.js"></script>
<script>
    $(function(){

        $( document ).ajaxStart(function() {
            $( "#loader" ).addClass('show');
        });
        $( document ).ajaxComplete(function() {
            $( "#loader" ).removeClass('show');
        });

        String.prototype.hashCode = function() {
            var hash = 0, i, chr, len;
            if (this.length){
                for (i = 0, len = this.length; i < len; i++) {
                    chr   = this.charCodeAt(i);
                    hash  = ((hash << 5) - hash) + chr;
                    //hash |= 0; // Convert to 32bit integer
                }
                if(hash < 0){
                    hash = hash * -1;
                }
            }
            return hash;
        };

        function getSheetsu(wtd){
            var url = $('#getUrl').val();
            if(wtd == 'dataFile'){
                var key = $('[name="dataFileKey"]:checked').val();
                if(typeof key == 'undefined'){
                    alert('Please select a key');
                    return;
                }
            }
            $.ajax({
                url: url,
                success: function(response, status, jqXHR) {
                    switch(wtd){
                        case 'check':
                            if(response.status == 200){
                                $('#getUrlFeedback, #getUrlAlert, #apiOk').removeClass('hidden');
                                $('#getUrl').parents('.form-group').addClass('has-feedback has-success');
                                var singleResponse = response.result[0];
                                var theHTML = '<table class="table table-condensed"><tbody>';
                                var frontMatterKeys = '<ul class="list-unstyled">';
                                var contentSelect = '';
                                $.each(singleResponse,function(i,v){
                                    var normIndex = i.replace(/[^\w\s\d]/gi,'');
                                    normIndex = normIndex.replace(/[\s]/gi,'-');
                                    frontMatterKeys += '<li>'+normIndex+'</li>';
                                    contentSelect += '<option value="'+i+'">'+i+'</option>';
                                    theHTML += '<tr><td><div class="radio"><label><input type="radio" name="dataFileKey" id="'+normIndex+'" value="'+i+'">'+i+'</label></td>';
                                    theHTML += '<td><div class="checkbox"><label for="'+normIndex+'-text"><input type="checkbox" id="'+normIndex+'-text">Text?</label></td>';
                                    theHTML += '<td><div class="checkbox"><label for="'+normIndex+'-include"><input type="checkbox" id="'+normIndex+'-include" checked>Include?</label></td>';
                                    theHTML += '<td><div class="checkbox"><label for="'+normIndex+'-slug"><input type="checkbox" id="'+normIndex+'-slug">Slugify?</label></td>';
                                    theHTML += '<td><div class="checkbox"><label for="'+normIndex+'-hash"><input type="checkbox" id="'+normIndex+'-hash">Hash?</label></td></tr>';
                                });
                                theHTML += '</tbody></table>';
                                $('#dataFileKey').html(theHTML);
                                $('#frontMatterKeys').html(frontMatterKeys);
                                $('#jekyllContent, #fileTitle').html(contentSelect);
                            }
                            break;
                        case 'simpleJson':
                            $('#response').html(JSON.stringify(response.result));
                            break;
                        case 'dataFile':
                            var key = $('[name="dataFileKey"]:checked').val();
                            var returnString = '';
                            $.each(response.result,function(index,value){
                                var dataKey = value[key].replace(/[\s]/gi,'-');
                                if($('#'+key+ '-hash').prop('checked')){
                                    console.log(dataKey.hashCode());
                                    returnString += dataKey.hashCode()+':\n';
                                } else {
                                    returnString += dataKey+':\n';
                                }
                                $.each(value,function(i,v){
                                    var normIndex = i.replace(/[^\w\s\d]/gi,'');
                                    normIndex = normIndex.replace(/[\s]/gi,'-');
                                    if($('#'+normIndex+'-include').prop('checked')) {
                                        if ($('#' + normIndex + '-text').prop('checked')) {
                                            returnString += '  ' + normIndex + ': |\r    ' + v + '\n';
                                        } else if($('#'+normIndex+ '-slug').prop('checked')) {
                                            var slugV = v.replace(/[^\w\d]/gi, '-');
                                            slugV = slugV.replace(/-(-+)/g, '-').toLowerCase();
                                            returnString += '  ' + normIndex + ': ' + slugV + '\n';
                                        } else if($('#'+normIndex+ '-hash').prop('checked')){
                                            returnString += '  ' + normIndex + ': ' + v.hashCode() + '\n';
                                        } else {
                                            returnString += '  ' + normIndex + ': ' + v + '\n';
                                        }
                                    }
                                });
                                returnString += '\n';
                            });
                            $('#response').html(returnString);
                            $('#step5').removeClass('hidden');
                            break;
                        case 'templates':
                            var zip = new JSZip();
                            var key = $('#jekyllContent').val();
                            var fileDate = $('#fileDate').val();
                            var fileTitleKey = $('#fileTitle').val();
                            $.each(response.result,function(index,value){
                                var returnString = '';
                                var template = $('#addFrontMatter').val();
                                var content = value[key];
                                var fileTitle =  value[fileTitleKey].replace(/[^\w\s\d]/gi,'');
                                fileTitle = fileTitle.replace(/[\s]/gi,'-');
                                var title = value[fileTitleKey];
                                title = title.replace(':','&#58;');
                                $.each(value,function(i,v){
                                    var normIndex = i.replace(/[^\w\s\d]/gi,'');
                                    normIndex = normIndex.replace(/[\s]/gi,'-');
                                    var re = new RegExp('\\['+normIndex+'\\]',"g");
                                    template = template.replace(re,v);
                                    var re = new RegExp('\\['+normIndex+'\\|slug\\]',"g");
                                    var slugV = v.replace(/[^\w\d]/gi,'-');
                                    slugV = slugV.replace(/-(-+)/g,'-').toLowerCase();
                                    template = template.replace(re,slugV);
                                    var re = new RegExp('\\['+normIndex+'\\|hash\\]',"g");
                                    template = template.replace(re, v.hashCode());
                                });
                                returnString += '---\n'+template+'\n'+'title: '+title+'\n---\r\n'+'<p>'+content+'</p>';
                                zip.folder('fromSheetsToJekyll').file(fileDate+'-'+fileTitle+'.html',returnString);
                                //$('#response').append(returnString);
                            });

                            //$('#step5').removeClass('hidden');
                            var a = document.createElement('a');
                            var odsFile = zip.generate({type:'blob'});
                            var url = window.URL.createObjectURL(odsFile);
                            a.href = url;
                            a.download = 'fromSheetsToJekyll.zip';
                            a.click();
                            break;
                    }
                }
            });
        }

        $('#checkUrl').click(function(){
            getSheetsu('check');
        });

        $('#boom').click(function(){
            var wtd = $('.tab-pane.active').attr('id');
            getSheetsu(wtd);
        });

    });
</script>
</html>